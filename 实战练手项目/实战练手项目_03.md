## ThreadLocal 保存登录用户信息

- 在拦截器（或过滤器）中获取当前请求的用户凭证（如 token、sessionId）。

- 调用服务层校验凭证，查出对应的用户实体（User 对象）。

- 使用 `ThreadLocal<User>` 将当前线程的用户信息存储起来，便于后续任何位置直接调用 `UserContext.getUser()` 获取。

- 在请求结束后，务必在 `finally` 块中调用 `ThreadLocal.remove()`，防止内存泄漏和线程复用时数据污染。

  

## ThreadLocal 内存泄漏

- 分析 `ThreadLocalMap` 的内部结构：Entry 以弱引用方式关联 key，value 为强引用。

- 当 key 被回收后，entry 仍在 map 中但 key 为 null，value 不会被清理，造成内存泄漏。

- 解决方案：

  - 每次使用完毕后手动 `remove()`。

  - 定期或在业务高峰退出阶段调用 `ThreadLocal` 的 `ThreadLocalMap` 清理 API（JDK 9+）。

  - 使用框架提供的工具类（如 Spring 的 `RequestContextHolder`）统一管理。

  

## 文章详情

- 前端通过 REST 接口 `/articles/{id}` 发起 GET 请求，后端 Controller 接收参数后调用 Service。

- Service 层根据文章 ID 查询数据库，关联查询作者信息、标签列表、分类信息等。

- 如果文章不存在，抛出自定义异常（如 `NotFoundException`），并在 ControllerAdvice 中统一处理返回 404。

- DTO 转换：将数据库实体转换为前端所需的 `ArticleDetailDTO`，屏蔽敏感字段，格式化日期。

  

## 线程池的使用

- 介绍 JDK 原生 `ThreadPoolExecutor` 构造参数：

  - corePoolSize、maximumPoolSize、keepAliveTime、workQueue、threadFactory、RejectedExecutionHandler。

- 根据业务场景选择合适的队列类型（`LinkedBlockingQueue`、`SynchronousQueue`、`ArrayBlockingQueue`）。

- 演示如何通过 Spring Boot 配置文件（`application.yml`）注入自定义线程池：

  ```yaml

  spring:

    task:

      execution:

        pool:

          core-size: 5

          max-size: 10

          queue-capacity: 50

  ```

- 推荐在 `@Async` 注解或定时任务中使用该线程池，避免占用 Tomcat 容器线程。

  

## 阅读次数 Bug 修正

- 问题：并发环境下，多次 GET 请求会导致阅读量统计不准确或丢失。

- 原因：直接在 Controller 中查询、修改再保存，存在读–改–写竞态。

- 解决：

  - 使用数据库的原子操作语句：`UPDATE article SET views = views + 1 WHERE id = ?`。

  - 或者在 Service 层使用分布式锁保证同一时刻只有一个线程更新计数。

  - 考虑使用缓存（如 Redis）的自增命令 `INCR` 来减少数据库压力，再定时落库。

  

## 评论功能

- 评论实体包含：评论 ID、文章 ID、用户 ID、内容、父评论 ID（用于评论回复）、创建时间。

- 后端接口设计：

  - `POST /articles/{id}/comments`：新增评论。

  - `GET  /articles/{id}/comments`：获取所有一级评论，并可携带参数获取回复列表或分页。

  - `PUT  /comments/{id}`：更新自己的评论。

  - `DELETE /comments/{id}`：删除自己的评论（软删除或硬删除，根据业务）。

- 业务逻辑：

  - 新评论入库同时更新文章的评论计数（可用事务或异步事件）。

  - 对敏感词或 XSS 进行校验与过滤。

  

## 写文章：所有分类

- 分类表 `category` 包含 ID、名称、父级 ID（支持树形结构）、排序字段。

- 发布文章时，先查询所有分类列表构建树状下拉菜单，使用递归或 SQL 的 `WITH RECURSIVE`。

- 前端展示可选一级或多级分类，提交后保存文章与分类的关联表 `article_category`。

  

## 写文章：所有标签

- 标签表 `tag` 包含 ID、名称、使用次数等。

- 页面加载时查询热门标签列表，用户也可输入新标签。

- 前端输入时可做自动补全（Ajax 查询）。

- 提交时：

  - 对比已有标签，新增不存在的，返回其 ID 列表。

  - 将文章 ID 与标签 ID 插入关联表 `article_tag`。

  

## 发布文章

- 接收文章标题、内容、分类 ID、标签 ID 列表、封面图片 URL 等参数。

- 业务校验：

  - 标题与内容不能为空，分类必须存在，标签数量上限（如最多 5 个）。

- 事务管理：

  - 保存文章主表后保存关联分类、标签表；任何一步异常都回滚。

- 发布后可通过消息队列（如 RabbitMQ）异步通知搜索引擎更新、生成静态页面等。

  

## AOP 记录日志

- 定义切面 `@Aspect`，在 `@Pointcut` 指定需要记录的 Controller 或 Service 方法。

- 使用 `@Around` 或 `@AfterReturning` 执行日志记录：

  - 日志内容：操作人、操作时间、请求 URL、请求参数、返回结果、执行耗时等。

- 日志存储：

  - 可写入数据库表 `sys_log`，或输出到文件/Elasticsearch 以便后续分析。

- 演示如何在配置中开启或关闭日志切面，避免生产环境性能影响。

  

## 文章归档 Bug 修复

- 归档逻辑：按年月统计文章数，常用 SQL：

  ```sql

  SELECT DATE_FORMAT(create_date, '%Y年%m月') AS period, COUNT(*) AS count

  FROM article

  GROUP BY period

  ORDER BY period DESC;

  ```

- Bug：当某月没有文章时报空或顺序异常。

- 修正：

  - 增加空数据处理，返回空列表而非 null。

  - 对 SQL 进行兼容性调整，确保数据库方言正确处理日期格式。

  

## 文章图片上传

- 前端使用 `FormData` 上传图片，后端接收 `MultipartFile`。

- 存储方案：

  - 本地文件系统 + 定时清理旧文件。

  - 或者直接上传到对象存储服务（如阿里 OSS、七牛云），返回外链 URL。

- 服务端校验：

  - 文件类型（JPEG/PNG/GIF）、大小限制（如 ≤ 2MB）。

  - 对文件名做随机化处理，防止同名覆盖。

  

## 导航：文章分类

- 在公共 Controller 中加载一级分类列表，缓存到 Redis。

- 前端导航栏下拉显示分类名称，点击后跳转到分类页面。

- 使用 `@ControllerAdvice` 或拦截器统一注入分类数据，减少重复查询。

  

## 分类文章列表

- 接口 `GET /categories/{id}/articles?page=1&size=10`：

  - 根据分类 ID 查询文章，支持分页和排序（如按创建时间倒序）。

- 业务注意：

  - 若分类下无文章，返回空列表并给出友好提示。

  - 可添加筛选参数，如按标签、按作者等。

  

## 标签文章列表

- 接口 `GET /tags/{id}/articles`，逻辑同分类文章列表。

- 可展示该标签下的热门文章、最新文章两个视图。

- 前端标签页切换时发送不同参数以加载对应列表。

  

## 归档文章列表

- 接口 `GET /archives/{period}`，如 `/archives/2025年07月`。

- 查询条件根据年月字符串解析为日期区间。

- 前端可展示年份折叠面板，月份展开后显示该月所有文章标题及链接。

  

## 统一缓存处理（优化）

- 引入统一缓存注解 `@Cacheable`、`@CacheEvict`、`@CachePut`。

- 定义缓存 key 生成策略，避免 key 冲突。

- 全局配置 Redis 连接池、序列化方式（使用 FastJson 或 Kryo 以提升性能）。

- 建议对热点数据（分类、标签、导航）做长期缓存，对动态数据（文章详情、评论）做短期缓存。

  

## 统一缓存精度 Bug

- 问题：同一缓存 key 下不同行为未按需失效或更新，导致数据不一致。

- 定位：

  - 检查 `@CacheEvict` 的 `allEntries` 和 `key` 配置是否正确。

  - 分析方法调用链，确认业务更新数据库后是否同步清理缓存。

- 修复：

  - 在 Service 更新文章、评论、阅读量后，明确调用 `cacheManager.clear()` 或对应 `@CacheEvict`。

  

## 思考其他优化及作业

- 建议：

  - 前端静态资源（JS/CSS）使用 CDN 加速。

  - 数据库分库分表策略探讨。

  - 接口防刷与限流（如 Spring Cloud Gateway 限流）。

- 作业：

  - 为评论功能添加二级回复展示。

  - 对文章列表接口增加 Elasticsearch 全文检索支持。

  - 实现用户点赞功能并统计热度。

  

## 管理后台：搭建工程

- 后端：

  - 新建 Maven 项目或模块，导入 Spring Boot、MyBatis-Plus、Swagger 等依赖。

  - 配置安全认证（如 Spring Security 或 JWT）。

- 前端：

  - 使用 Vue3 + Vite 脚手架初始化项目。

  - 整合 Element Plus 或 Ant Design Vue，搭建基本布局（侧边栏 + 顶部导航）。

- 接口联调：

  - 使用 Mock 数据或 Swagger-UI 进行前后端分离开发。

  - 定义统一返回格式和错误码规范。